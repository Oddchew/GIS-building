<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Подбор площадки под строительство</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="controls">
        <label>Тип здания:
            <select id="building-type">
                <option value="house">Дом</option>
                <option value="cottage">Коттедж</option>
                <option value="warehouse">Склад</option>
            </select>
        </label>
        <label>Размер дома (метры):
            <input type="number" id="size-input" min="5" max="60" value="10">
        </label>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([55.75, 37.62], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let currentMarker = null;
        let currentHouseArea = null;

        map.on('click', async (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const buildingType = document.getElementById('building-type').value;
            const size = parseFloat(document.getElementById('size-input').value);

            if (isNaN(size) || size < 5 || size > 60) {
                alert("Размер должен быть от 5 до 60 метров");
                return;
            }

            if (currentMarker) map.removeLayer(currentMarker);
            if (currentHouseArea) map.removeLayer(currentHouseArea);

            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lng, building_type: buildingType, size })
                });

                const result = await response.json();

                const color = result.allowed ? 'green' : 'red';
                const message = result.allowed 
                    ? `✅ Можно построить дом ${size} м!` 
                    : `❌ ${result.reason}`;

                currentMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(message).openPopup();

                // Визуализация дома
                currentHouseArea = L.circle([lat, lng], {
                    radius: size / 2, // Leaflet принимает радиус в МЕТРАХ!
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

            } catch (err) {
                console.error("Ошибка:", err);
                alert("Ошибка при проверке. Подробности в консоли.");
            }
        });
    </script>
</body>
</html>