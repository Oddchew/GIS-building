<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ–¥–±–æ—Ä –ø–ª–æ—â–∞–¥–∫–∏ –ø–æ–¥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="controls">
        <label>–¢–∏–ø –∑–¥–∞–Ω–∏—è:
            <select id="building-type">
                <option value="house">–î–æ–º</option>
                <option value="cottage">–ö–æ—Ç—Ç–µ–¥–∂</option>
                <option value="warehouse">–°–∫–ª–∞–¥</option>
            </select>
        </label>
        <label>–î–ª–∏–Ω–∞ (–º):
            <input type="number" id="length-input" min="5" max="100" value="12">
        </label>
        <label>–®–∏—Ä–∏–Ω–∞ (–º):
            <input type="number" id="width-input" min="5" max="60" value="8">
        </label>
        <label>–ü–æ–≤–æ—Ä–æ—Ç (¬∞):
            <input type="range" id="rotation-slider" min="0" max="360" value="0">
            <span id="rotation-value">0¬∞</span>
        </label>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', {
            zoomControl: true,
            attributionControl: true
        }).setView([55.75, 37.62], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // ‚úÖ –õ–∏–Ω–µ–π–∫–∞ –º–∞—Å—à—Ç–∞–±–∞ (–≤ –º–µ—Ç—Ä–∞—Ö)
        L.control.scale({imperial: false, maxWidth: 200}).addTo(map);

        let currentMarker = null;
        let currentHousePoly = null;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–≥–ª–∞
        const rotSlider = document.getElementById('rotation-slider');
        const rotValue = document.getElementById('rotation-value');
        rotSlider.addEventListener('input', () => {
            rotValue.textContent = rotSlider.value + '¬∞';
        });

        map.on('click', async (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const buildingType = document.getElementById('building-type').value;
            const length = parseFloat(document.getElementById('length-input').value);
            const width = parseFloat(document.getElementById('width-input').value);
            const rotation = parseFloat(rotSlider.value); // –≤ –≥—Ä–∞–¥—É—Å–∞—Ö

            if (isNaN(length) || isNaN(width) || length < 5 || width < 5) {
                alert("–î–ª–∏–Ω–∞ –∏ —à–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ‚â• 5 –º");
                return;
            }

            if (currentMarker) map.removeLayer(currentMarker);
            if (currentHousePoly) map.removeLayer(currentHousePoly);

            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lng, building_type: buildingType, length, width, rotation })
                });

                const result = await response.json();

                const color = result.allowed ? 'green' : 'red';
                const message = result.allowed 
                    ? `‚úÖ –ú–æ–∂–Ω–æ: ${length}√ó${width} –º, –ø–æ–≤–æ—Ä–æ—Ç ${rotation}¬∞` 
                    : `‚ùå ${result.reason}`;

                currentMarker = L.circleMarker([lat, lng], {
                    radius: 5,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(message).openPopup();

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
                const cornerLatsLngs = getRotatedRectangle(lat, lng, length, width, rotation);
                currentHousePoly = L.polygon(cornerLatsLngs, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞:", err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ.");
            }
        });

        // üåç –§—É–Ω–∫—Ü–∏—è: —Å—Ç—Ä–æ–∏—Ç –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö [lat, lng]
        function getRotatedRectangle(centerLat, centerLng, lengthM, widthM, angleDeg) {
            const earthRadius = 6378137; // –º–µ—Ç—Ä–æ–≤
            const angleRad = angleDeg * Math.PI / 180;

            // –ü–æ–ª–æ–≤–∏–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            const halfLen = lengthM / 2;
            const halfWid = widthM / 2;

            // –£–≥–ª–æ–≤—ã–µ —Å–º–µ—â–µ–Ω–∏—è –≤ –º–µ—Ç—Ä–∞—Ö (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
            const cornersM = [
                [-halfWid,  halfLen], // –ª–µ–≤–æ-–≤–µ—Ä—Ö
                [ halfWid,  halfLen], // –ø—Ä–∞–≤–æ-–≤–µ—Ä—Ö
                [ halfWid, -halfLen], // –ø—Ä–∞–≤–æ-–Ω–∏–∑
                [-halfWid, -halfLen]  // –ª–µ–≤–æ-–Ω–∏–∑
            ];

            // –ü–æ–≤–æ—Ä–æ—Ç –≤ –º–µ—Ç—Ä–∞—Ö
            const rotatedCornersM = cornersM.map(([x, y]) => {
                const xRot = x * Math.cos(angleRad) - y * Math.sin(angleRad);
                const yRot = x * Math.sin(angleRad) + y * Math.cos(angleRad);
                return [xRot, yRot];
            });

            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å–º–µ—â–µ–Ω–∏–π (–º–µ—Ç—Ä—ã ‚Üí –≥—Ä–∞–¥—É—Å—ã)
            const cosLat = Math.cos(centerLat * Math.PI / 180);
            const metersPerDegLat = 111132.92;
            const metersPerDegLng = 111412.84 * cosLat;

            return rotatedCornersM.map(([dx, dy]) => {
                const dLat = dy / metersPerDegLat;
                const dLng = dx / metersPerDegLng;
                return [centerLat + dLat, centerLng + dLng];
            });
        }
    </script>
</body>
</html>